<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:pro="http://www.liquibase.org/xml/ns/pro" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-4.6.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.6.xsd">
    <changeSet author="dhite (generated)" id="entity_type_table">
        <createTable tableName="entity_type">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="entity_type_pkey"/>
            </column>
            <column name="name" type="VARCHAR">
                <constraints nullable="false"/>
            </column>
            <column name="workspace_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column defaultValueBoolean="false" name="full_text_indexed" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="dhite (generated)" id="entity_table">
        <createTable tableName="entity">
            <column name="entity_type" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="entity_pkey"/>
            </column>
            <column name="record_version" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR">
                <constraints nullable="false" primaryKey="true" primaryKeyName="entity_pkey"/>
            </column>
            <column name="deleted" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="attributes" type="JSONB">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="dhite (generated)" id="workspace_table">
        <createTable tableName="workspace">
            <column name="id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR">
                <constraints nullable="false" primaryKey="true" primaryKeyName="workspace_pkey"/>
            </column>
            <column name="namespace" type="VARCHAR">
                <constraints nullable="false" primaryKey="true" primaryKeyName="workspace_pkey"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="dhite (generated)" id="ws_id_uniq">
        <createIndex indexName="uniq_ws" tableName="workspace" unique="true">
            <column name="id"/>
        </createIndex>
    </changeSet>

    <changeSet author="dhite (generated)" id="entity_type_idx">
        <createIndex indexName="entity_type_ws_idx" tableName="entity_type" unique="true">
            <column name="workspace_id"/>
            <column name="name"/>
        </createIndex>
    </changeSet>


    <changeSet author="dhite (generated)" id="entity_type_fk">
        <addForeignKeyConstraint baseColumnNames="entity_type" baseTableName="entity" constraintName="type_reference_fk" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="entity_type" validate="true"/>
    </changeSet>
    <changeSet author="dhite (generated)" id="ws_fk">
        <addForeignKeyConstraint baseColumnNames="workspace_id" baseTableName="entity_type" constraintName="ws_reference_fk" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="workspace" validate="true"/>
    </changeSet>

    <changeSet id="entity_reference_table" author="dhite">
        <createTable tableName="entity_reference">
            <column name="entity_type" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="entity_reference_pkey"/>
            </column>
            <column name="entity_name" type="VARCHAR">
                <constraints nullable="false" primaryKey="true" primaryKeyName="entity_reference_pkey"/>
            </column>
            <column name="referenced_entity_type" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="entity_reference_pkey"/>
            </column>
            <column name="referenced_entity_name" type="VARCHAR">
                <constraints nullable="false" primaryKey="true" primaryKeyName="entity_reference_pkey"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="dhite (generated)" id="1654718778099-157">
        <addForeignKeyConstraint baseColumnNames="referenced_entity_type,referenced_entity_name" baseTableName="entity_reference" constraintName="entity_reference_fk" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="entity_type,name" referencedTableName="entity" validate="true"/>
    </changeSet>
    <changeSet author="dhite (generated)" id="1654718778099-9">
        <createTable tableName="entity_attribute_info">
            <column name="entity_type" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="entity_attribute_concat_pkey"/>
            </column>
            <column name="entity_name" type="VARCHAR">
                <constraints nullable="false" primaryKey="true" primaryKeyName="entity_attribute_concat_pkey"/>
            </column>
            <column name="entity_attribute_values" type="VARCHAR"/>
            <column defaultValueComputed="ARRAY[]::character varying[]" name="entity_attribute_names" type="VARCHAR[]">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="dhite" id="create_attribute_triggers">
        <sql splitStatements="false">
            CREATE OR REPLACE FUNCTION entity_update() RETURNS trigger AS $entity_update$
            BEGIN
    if(OLD.attributes != NEW.attributes) then
        with q as (select string_agg(value, ' ') as attrs, array_agg(key) as attr_names from jsonb_each_text(NEW.attributes))
            update entity_attribute_info set entity_attribute_values = q.attrs, entity_attribute_names = q.attr_names
                from q
            where entity_type = NEW.entity_type and entity_name = NEW.name;
            end if;
            RETURN NEW;
            END;
            $entity_update$ LANGUAGE plpgsql;


CREATE OR REPLACE FUNCTION entity_insert() RETURNS trigger AS $entity_insert$
            BEGIN
            with q as (select string_agg(value, ' ') as attrs, array_agg(key) as attr_names from jsonb_each_text(NEW.attributes))
            insert into entity_attribute_info (entity_type, entity_name, entity_attribute_values, entity_attribute_names)
            select NEW.entity_type, NEW.name, q.attrs, q.attr_names from q;
            RETURN NEW;
            END;
            $entity_insert$ LANGUAGE plpgsql;
        </sql>
        <rollback>
            drop function entity_update cascade;
            drop function entity_insert cascade;
        </rollback>
    </changeSet>

</databaseChangeLog>
