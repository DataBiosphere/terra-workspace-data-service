openapi: 3.0.3

info:
  title: Workspace Data Service
  version: v0.2
  description: |
    This page lists both current and proposed APIs. The proposed APIs which have not yet been implemented
    are marked as deprecated. This is incongruous, but by using the deprecated flag, we can force
    swagger-ui to display those endpoints differently.

    Error codes and responses for proposed APIs are likely to change as we gain more clarity on their
    implementation.

    As of v0.2, all APIs are subject to change without notice.
  termsOfService: https://github.com/DataBiosphere/terra-workspace-data-service
  license:
    name: BSD
    url: http://opensource.org/licenses/BSD-3-Clause
servers:
  - url: ../
    description: Relative to the current swagger page
tags:
  - name: Records
    description: Record APIs
  - name: Instances
    description: Instance APIs
  - name: Schema
    description: Schema Manipulation APIs (coming soon)
paths:
  /{instanceid}/records/{v}/{type}/{id}:
    get:
      summary: Get record
      operationId: getRecord
      description: Retrieves a single record by its type and id
      tags:
        - Records
      parameters:
        - $ref: '#/components/parameters/instanceIdPathParam'
        - $ref: '#/components/parameters/versionPathParam'
        - $ref: '#/components/parameters/recordTypePathParam'
        - $ref: '#/components/parameters/recordIdPathParam'
      responses:
        200:
          $ref: '#/components/responses/RecordResponseBody'
        404:
          description: Record not found
          content:
            'application/json':
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      summary: Create or replace record
      description: |
        Creates or replaces the record using the specified type and id.
        If the record already exists, its entire set of attributes will be overwritten by
        the attributes in the request body.
        
        TODO: add a query parameter to allow/disallow overwriting existing records?
      operationId: createOrReplaceRecord
      tags:
        - Records
      parameters:
        - $ref: '#/components/parameters/instanceIdPathParam'
        - $ref: '#/components/parameters/versionPathParam'
        - $ref: '#/components/parameters/recordTypePathParam'
        - $ref: '#/components/parameters/recordIdPathParam'
      requestBody:
        $ref: '#/components/requestBodies/RecordRequestBody'
      responses:
        200:
          description: Record updated
          $ref: '#/components/responses/RecordResponseBody'
        201:
          description: Record created
          $ref: '#/components/responses/RecordResponseBody'
        400:
          description: Bad request
          content:
            'application/json':
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    patch:
      summary: Update record
      operationId: updateRecord
      description: |
        Updates the record of the specified type and id.
        Any attributes included in the request body will be created or overwritten.
        Attributes not included in the request body will be untouched in the database.
        No attributes will be deleted. To delete attributes, use the PUT api instead.
      tags:
        - Records
      parameters:
        - $ref: '#/components/parameters/instanceIdPathParam'
        - $ref: '#/components/parameters/versionPathParam'
        - $ref: '#/components/parameters/recordTypePathParam'
        - $ref: '#/components/parameters/recordIdPathParam'
      requestBody:
        $ref: '#/components/requestBodies/RecordRequestBody'
      responses:
        200:
          $ref: '#/components/responses/RecordResponseBody'
        404:
          description: Record not found
          content:
            'application/json':
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        400:
          description: Bad request
          content:
            'application/json':
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      summary: Delete record
      description: Deletes the record at the specified type and id.
      operationId: deleteRecord
      tags:
        - Records
      parameters:
        - $ref: '#/components/parameters/instanceIdPathParam'
        - $ref: '#/components/parameters/versionPathParam'
        - $ref: '#/components/parameters/recordTypePathParam'
        - $ref: '#/components/parameters/recordIdPathParam'
      responses:
        204:
          description: Success
        404:
          description: Record not found
          content:
            'application/json':
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        400:
          description: Bad request
          content:
            'application/json':
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /{instanceid}/search/{v}/{type}:
    post:
      summary: Query records
      description: Paginated list of records matching the criteria supplied in the request body
      operationId: queryRecords
      tags:
        - Records
      parameters:
        - $ref: '#/components/parameters/instanceIdPathParam'
        - $ref: '#/components/parameters/versionPathParam'
        - $ref: '#/components/parameters/recordTypePathParam'
      requestBody:
        $ref: '#/components/requestBodies/SearchRequestBody'
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecordQueryResponse'
        404:
          description: Record type not found
          content:
            'application/json':
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /{instanceid}/tsv/{v}/{type}:
    get:
      summary: Retrieve all records in record type as tsv.
      operationId: getRecordsAsTsv
      description: Streams all records in a record type to a tsv format.
      tags:
        - Records
      parameters:
        - $ref: '#/components/parameters/instanceIdPathParam'
        - $ref: '#/components/parameters/versionPathParam'
        - $ref: '#/components/parameters/recordTypePathParam'
      responses:
        200:
          description: Records in tsv format
          content:
            text/tab-separated-values:
              schema:
                type: string
                format: binary
        404:
          description: Instance or Record type not found
          content:
            'application/json':
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      summary: Import records to a record type from a tsv file
      description: Upload a tsv to modify or create records in a record type.  This operation will insert or update records.
      tags:
        - Records
      operationId: uploadTSV
      parameters:
        - $ref: '#/components/parameters/instanceIdPathParam'
        - $ref: '#/components/parameters/versionPathParam'
        - $ref: '#/components/parameters/recordTypePathParam'
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - records
              properties:
                records:
                  type: string
                  description: A valid TSV import file
                  format: binary
        required: true
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TsvUploadResponse'
        400:
          description: Bad Request
          content:
            'application/json':
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        404:
          description: Instance not found
          content:
            'application/json':
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /{instanceid}/batch/{v}/{type}:
    post:
      summary: Batch write records
      description: Perform a batch of upsert / delete operations on multiple records
      operationId: batchWriteRecords
      tags:
        - Records
      parameters:
        - $ref: '#/components/parameters/instanceIdPathParam'
        - $ref: '#/components/parameters/versionPathParam'
        - $ref: '#/components/parameters/recordTypePathParam'
      requestBody:
        $ref: '#/components/requestBodies/BatchRequestBody'
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchResponse'
  /instances/{v}/{instanceid}:
    post:
      summary: Create an instance (unstable)
      description: Create an instance with the given UUID. This API is liable to change.
      operationId: createWDSInstance
      tags:
        - Instances
      parameters:
        - $ref: '#/components/parameters/instanceIdPathParam'
        - $ref: '#/components/parameters/versionPathParam'
      responses:
        201:
          description: Success
        409:
          description: Conflict - schema already exists.
          content:
            'application/json':
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /{instanceid}/types/{v}/{type}:
    get:
      summary: Describe record type
      description: |
        Returns the schema definition for this type.
      operationId: describeRecordType
      tags:
        - Schema
      parameters:
        - $ref: '#/components/parameters/instanceIdPathParam'
        - $ref: '#/components/parameters/versionPathParam'
        - $ref: '#/components/parameters/recordTypePathParam'
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecordTypeSchema'
        404:
          description: Record type not found
          content:
            'application/json':
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    patch:
      deprecated: true
      summary: Update record type (pending)
      description: |
        Update record type. All records of the old type will be updated to the new type.
        This API can be used to rename a record type and/or to perform batch updates to
        this type's attributes; see also the updateAttribute API.
        This API cannot be used to delete attributes; use deleteAttribute instead.
        Returns the updated type definition.
      operationId: updateRecordType
      tags:
        - Schema
      parameters:
        - $ref: '#/components/parameters/instanceIdPathParam'
        - $ref: '#/components/parameters/versionPathParam'
        - $ref: '#/components/parameters/recordTypePathParam'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RecordTypeSchema'
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecordTypeSchema'
        400:
          description: Malformed payload; or invalid type name; or invalid attribute name, datatype, or relation target
        409:
          description: Target type or attribute name already exists, for a rename operation
    delete:
      summary: Delete record type
      description: Delete record type. All records of this type will be deleted.
      operationId: deleteRecordType
      tags:
        - Schema
      parameters:
        - $ref: '#/components/parameters/instanceIdPathParam'
        - $ref: '#/components/parameters/versionPathParam'
        - $ref: '#/components/parameters/recordTypePathParam'
      responses:
        204:
          description: Success
        409:
          description: at least one of the records to be deleted is a relation target
  /{instanceid}/types/{v}:
    get:
      summary: Describe all record types
      description: |
        Returns the schema definition for all types in this instance.
      operationId: describeAllRecordTypes
      tags:
        - Schema
      parameters:
        - $ref: '#/components/parameters/instanceIdPathParam'
        - $ref: '#/components/parameters/versionPathParam'
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/RecordTypeSchema'
        404:
          description: Instance not found
          content:
            'application/json':
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /{instanceid}/types/{type}/attributes/{v}/{attribute}:
    get:
      deprecated: true
      summary: Describe attribute (pending)
      description: |
        Returns the schema definition for this attribute.
      operationId: describeAttribute
      tags:
        - Schema
      parameters:
        - $ref: '#/components/parameters/instanceIdPathParam'
        - $ref: '#/components/parameters/versionPathParam'
        - $ref: '#/components/parameters/recordTypePathParam'
        - $ref: '#/components/parameters/attributePathParam'
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AttributeSchema'
    patch:
      deprecated: true
      summary: Update attribute (pending)
      description: |
        Update attribute. All records of the specified type that contain the old attribute will now have the new attribute instead.
        When changing datatypes, WDS will make a best effort to cast the existing values into the new datatype.
        Any values that cannot be successfully cast will be changed to null.
        Returns the updated attribute definition.
      operationId: updateAttribute
      tags:
        - Schema
      parameters:
        - $ref: '#/components/parameters/instanceIdPathParam'
        - $ref: '#/components/parameters/versionPathParam'
        - $ref: '#/components/parameters/recordTypePathParam'
        - $ref: '#/components/parameters/attributePathParam'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AttributeSchema'
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AttributeSchema'
        400:
          description: Malformed payload; or invalid name, datatype, or relation target
        409:
          description: Target attribute name already exists, for a rename operation
    delete:
      deprecated: true
      summary: Delete attribute (pending)
      description: |
        Delete attribute. This deletes all values for this attribute within the specified type.
      operationId: deleteAttribute
      tags:
        - Schema
      parameters:
        - $ref: '#/components/parameters/instanceIdPathParam'
        - $ref: '#/components/parameters/versionPathParam'
        - $ref: '#/components/parameters/recordTypePathParam'
        - $ref: '#/components/parameters/attributePathParam'
      responses:
        204:
          description: Success

components:
  parameters:
    attributePathParam:
      name: attribute
      in: path
      description: Attribute name
      required: true
      schema:
        type: string
    recordIdPathParam:
      name: id
      in: path
      description: Record id
      required: true
      schema:
        type: string
    recordTypePathParam:
      name: type
      in: path
      description: Record type
      required: true
      schema:
        type: string
    instanceIdPathParam:
      name: instanceid
      in: path
      description: WDS instance id; by convention equal to workspace id
      required: true
      schema:
        type: string
    versionPathParam:
      name: v
      in: path
      description: API version
      required: true
      schema:
        type: string
        default: v0.2
  responses:
    RecordResponseBody:
      description: A record
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/RecordResponse'
  requestBodies:
    SearchRequestBody:
      description: A paginated search request
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SearchRequest'
    RecordRequestBody:
      description: A record's attributes to upload
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/RecordRequest'
    BatchRequestBody:
      description: A list of batch operations to perform on records
      required: true
      content:
        application/json:
          schema:
            type: array
            items:
              $ref: '#/components/schemas/BatchOperation'
  schemas:
    AttributeSchema:
      type: object
      required:
        - name
        - datatype
      properties:
        name:
          type: string
          description: name of this attribute.
        datatype:
          type: string
          enum: [boolean, date, datetime, string, json, long, double, relation, array_of_boolean, array_of_string, array_of_number, array_of_date, array_of_datetime]
          description: |
            Datatype of this attribute. The enum of datatypes is in flux and will change. Please
            comment at https://docs.google.com/document/d/1d352ZoN5kEYWPjy0NqqWGxdf7HEu5VEdrLmiAv7dMmQ/edit#heading=h.naxag0augkgf.
        relatesTo:
          type: string
          description: Name of type to which this attribute relates. Only present if this is a relation attribute.
    BatchOperation:
      type: object
      required:
        - operation
        - record
      properties:
        operation:
          type: string
          enum: [upsert, delete]
        record:
          $ref: '#/components/schemas/BatchRecordRequest'
    BatchRecordRequest:
      type: object
      required:
        - id
        - type
        - attributes
      properties:
        id:
          $ref: '#/components/schemas/RecordId'
        type:
          $ref: '#/components/schemas/RecordType'
        attributes:
          $ref: '#/components/schemas/RecordAttributes'
    BatchResponse:
      type: object
      required:
        - message
        - recordsModified
      properties:
        message:
          type: string
        recordsModified:
          type: integer
    TsvUploadResponse:
      type: object
      required:
        - message
        - recordsModified
      properties:
        message:
          type: string
        recordsModified:
          type: integer

    SearchRequest:
      type: object
      properties:
        offset:
          $ref: '#/components/schemas/SearchOffset'
        limit:
          $ref: '#/components/schemas/SearchLimit'
        sort:
          $ref: '#/components/schemas/SearchSortDirection'
        sortAttribute:
          type: string
    RecordRequest:
      type: object
      required:
        - attributes
      properties:
        attributes:
          $ref: '#/components/schemas/RecordAttributes'
          description: KVPs of record attributes, valid characters for attribute names are limited to letters, numbers, spaces, dashes, and underscores.
    RecordResponse:
      required:
        - id
        - type
        - metadata
        - attributes
      type: object
      properties:
        id:
          $ref: '#/components/schemas/RecordId'
          description: Record id
        type:
          $ref: '#/components/schemas/RecordType'
          description: Record type
        attributes:
          $ref: '#/components/schemas/RecordAttributes'
          description: KVPs of record attributes
        metadata:
          $ref: '#/components/schemas/RecordMetadata'
          description: Provenance and other record metadata. May not be present in v0.2.
    RecordAttributes:
      type: object
      additionalProperties: true
      example: |
        {
          "stringAttr": "string",
          "numericAttr": 123,
          "booleanAttr": true,
          "relationAttr": "terra-wds:/target-type/target-id",
          "arrayString": ["green", "red"],
          "arrayBoolean": [true, false],
          "arrayNumber": [12821.112, 0.12121211, 11],
          "arrayDate": ["2022-11-03"],
          "arrayDateTime": ["2022-11-03T04:36:20"]
        }
    RecordAttributeDefinition:
      required:
        - name
      type: object
      properties:
        name:
          type: string
          description: Attribute name
    RecordId:
      type: string
    RecordMetadata:
      type: object
    RecordQueryResponse:
      required:
        - searchRequest
        - records
        - totalRecords
      type: object
      properties:
        searchRequest:
          $ref: '#/components/schemas/SearchRequest'
        totalRecords:
          type: integer
          description: number of records in the record type
        records:
          type: array
          items:
            $ref: '#/components/schemas/RecordResponse'
          description: list of records found
    RecordType:
      type: string
    RecordTypeSchema:
      required:
        - name
        - attributes
        - count
      type: object
      properties:
        name:
          type: string
          description: Record type name, valid characters for record type names are limited to letters, numbers, spaces, dashes, and underscores.
        attributes:
          type: array
          items:
            $ref: '#/components/schemas/AttributeSchema'
        count:
          type: integer
          description: Number of records of this type
    ErrorResponse:
      required:
        - status
        - path
        - message
        - error
        - timestamp
      type: object
      properties:
        status:
          type: integer
          description: HTTP status code
        error:
          type: string
          description: error
        message:
          type: string
          description: error message
        path:
          type: string
          description: requested record path
        timestamp:
          type: string
          description: time of error
      description: ""
    RequestBodySearch:
      required:
        - terms
      type: object
      description: |
        v0.2 only supports `terms` and `operator`. Future versions may support additional functionality.
      properties:
        terms:
          $ref: '#/components/schemas/SearchTerms'
        operator:
          $ref: '#/components/schemas/SearchOperator'
    SearchLimit:
      type: integer
      default: 10
      minimum: 0
      maximum: 1000
      description: Pagination limit
    SearchOffset:
      type: integer
      default: 0
      minimum: 0
      description: Pagination offset
    SearchOperator:
      type: string
      enum: [and, or]
      description: Search behavior for multiple filter terms
    SearchSortDirection:
      type: string
      enum: [asc, desc]
      default: asc
      description: |
        Sort direction (descending or ascending)
    SearchTerms:
      type: string
      description: Space-delimited list of terms on which to search
    StackTraceElement:
      required:
        - className
        - fileName
        - lineNumber
        - methodName
      type: object
      properties:
        className:
          type: string
          description: class name
        methodName:
          type: string
          description: method name
        fileName:
          type: string
          description: source file name
        lineNumber:
          type: integer
          description: line number
      description: ""
