plugins {
	id 'org.springframework.boot'
	id 'com.google.cloud.tools.jib'
	id 'org.hidetake.swagger.generator'
	id 'org.sonarqube'
	id 'com.gorylenko.gradle-git-properties'
	id 'jacoco'
}

springBoot {
	buildInfo()
}

repositories {
	mavenCentral()
	maven { url 'https://broadinstitute.jfrog.io/artifactory/libs-snapshot' }
	maven { url 'https://broadinstitute.jfrog.io/artifactory/libs-release' }
}

jib {
	from {
		// see https://github.com/broadinstitute/dsp-appsec-blessed-images/tree/main/jre
		image = "us.gcr.io/broad-dsp-gcr-public/base/jre:17-distroless"
	}

	container {
		mainClass = 'org.databiosphere.workspacedataservice.WorkspaceDataServiceApplication'
		creationTime = "USE_CURRENT_TIMESTAMP"
	}
}

dependencies {
	implementation 'com.microsoft.azure:applicationinsights-runtime-attach:3.4.9'
	implementation 'org.springframework.boot:spring-boot-starter'
	implementation 'org.springframework.boot:spring-boot-starter-jdbc'
	implementation 'org.springframework.boot:spring-boot-starter-web'
	implementation 'org.springframework.retry:spring-retry:1.3.4'
	implementation 'org.aspectj:aspectjweaver:1.8.9' // required by spring-retry, not used directly by WDS
	implementation 'org.apache.commons:commons-lang3'
	implementation 'org.apache.commons:commons-csv:1.9.0'
	implementation 'com.google.guava:guava:31.1-jre'
	implementation 'org.postgresql:postgresql'
	implementation 'org.springframework.boot:spring-boot-starter-actuator'
	implementation 'org.webjars:webjars-locator-core:0.52'
	implementation 'io.sentry:sentry-logback:6.12.1'
	annotationProcessor 'org.springframework.boot:spring-boot-configuration-processor'
	runtimeOnly 'org.webjars.npm:swagger-ui-dist:4.12.0'
	developmentOnly 'org.springframework.boot:spring-boot-devtools'
	testImplementation 'org.springframework.boot:spring-boot-starter-test'
	testImplementation 'org.junit.jupiter:junit-jupiter:5.8.2'
	testImplementation project(':client')
}

sonarqube {
	properties {
		property "sonar.projectName", "terra-workspace-data-service"
		property "sonar.projectKey", "DataBiosphere_workspace-data-service"
		property "sonar.organization", "broad-databiosphere"
		property "sonar.host.url", "https://sonarcloud.io"
	}
}

tasks.named('test') {
	useJUnitPlatform()
	testLogging {
		events = ["passed", "failed", "skipped", "started"]
		exceptionFormat = "full"
	}
	environment "WORKSPACE_ID", "123e4567-e89b-12d3-a456-426614174000"
}

jacocoTestReport {
	reports {
		// sonarqube requires XML coverage output to upload coverage data
		xml.required = true
	}
}
